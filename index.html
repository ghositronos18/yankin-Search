<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Swift Search</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Favicon -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

<style>
/* ---------- GOOGLE-CLONE UI ---------- */
:root{
  --bg:#0b0e14;
  --card:#111827;
  --border:#374151;
  --text:#e8eaed;
  --link:#8ab4f8;
  --url:#34d399;
  --muted:#9ca3af;
  --accent:#8b5cf6;
}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:var(--bg);
  color:var(--text);
}
.user-image{
  position:absolute;
  top:12px;
  left:12px;
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid var(--accent);
  cursor:pointer;
}
/* Google-style top bar */
.google-bar{
  display:flex;
  align-items:center;
  gap:12px;
  margin:12px 16px;
}
.google-logo{
  font-size:1.6rem;
  font-weight:500;
  color:var(--text);
}
.search-bar{
  flex:1;
  max-width:650px;
  position:relative;
}
.search-input{
  width:100%;
  padding:10px 44px 10px 16px;
  border:1px solid var(--border);
  border-radius:24px;
  background:var(--card);
  color:var(--text);
  outline:none;
}
.search-input:focus{
  border-color:var(--accent);
}
.search-bar-icons{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  display:flex;
  gap:8px;
}
.icon-btn{
  background:none;
  border:none;
  color:var(--muted);
  cursor:pointer;
  font-size:1.1rem;
}
/* Google-style result cards */
.result-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px 18px;
  margin:10px 16px;
  transition:background .2s;
}
.result-card:hover{
  background:#1a2332;
}
.result-title{
  font-size:1.1rem;
  color:var(--link);
  text-decoration:none;
  display:block;
  margin-bottom:4px;
}
.result-title:visited{
  color:#c58af9;
}
.result-url{
  color:var(--url);
  font-size:.9rem;
  margin-bottom:4px;
}
.result-snippet{
  color:var(--text);
  font-size:.95rem;
  line-height:1.5;
}
.result-favicon{
  width:16px;
  height:16px;
  vertical-align:middle;
  margin-right:6px;
}
/* Tabs (All, Images, Videos, News, Maps) */
.tabs{
  display:flex;
  gap:6px;
  margin:0 16px 12px;
  border-bottom:1px solid var(--border);
}
.tab{
  padding:8px 14px;
  cursor:pointer;
  border-bottom:2px solid transparent;
  color:var(--muted);
  font-size:.9rem;
}
.tab.active{
  color:var(--text);
  border-color:var(--accent);
}
/* Pagination */
.pagination{
  display:flex;
  gap:6px;
  justify-content:center;
  margin:20px 0;
}
.page-btn{
  padding:6px 12px;
  border:1px solid var(--border);
  background:var(--card);
  color:var(--text);
  border-radius:6px;
  cursor:pointer;
}
.page-btn:hover{
  border-color:var(--accent);
}
/* Music, file, etc. keep existing styles */
.music-options{
  display:flex;
  gap:10px;
  margin-top:10px;
  flex-wrap:wrap;
}
.music-btn{
  padding:8px 16px;
  background:var(--border);
  border-radius:20px;
  font-size:.9rem;
  cursor:pointer;
  border:none;
  color:var(--text);
}
.music-btn:hover{
  background:#4b5563;
}
.service-modal{ /* kept from old file */
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.modal-content{
  background:var(--card);
  border-radius:16px;
  padding:20px;
  max-width:500px;
  width:90%;
  max-height:80vh;
  overflow-y:auto;
}
.modal-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}
.modal-close{
  background:none;
  border:none;
  color:var(--muted);
  font-size:1.5rem;
  cursor:pointer;
}
.file-upload-area{
  border:2px dashed var(--border);
  border-radius:12px;
  padding:30px 20px;
  text-align:center;
  margin-top:15px;
  cursor:pointer;
  transition:border-color .2s;
}
.file-upload-area:hover{
  border-color:#3b82f6;
}
.file-upload-area.dragover{
  border-color:#10b981;
  background:#064e3b20;
}
.upload-icon{
  font-size:2rem;
  margin-bottom:10px;
}
#fileList{
  margin-top:15px;
  max-height:200px;
  overflow-y:auto;
}
.file-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:8px 12px;
  background:#1f2937;
  border-radius:8px;
  margin-bottom:6px;
}
.file-name{
  flex:1;
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}
.file-size{
  font-size:.8rem;
  color:var(--muted);
  margin-left:10px;
}
.file-actions{
  display:flex;
  gap:6px;
}
.file-action-btn{
  background:none;
  border:none;
  color:var(--muted);
  cursor:pointer;
  font-size:.9rem;
  padding:2px 6px;
}
.file-action-btn:hover{
  color:#3b82f6;
}
.file-services{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:10px;
  margin-top:10px;
}
.file-service{
  background:#1f2937;
  border-radius:12px;
  padding:12px;
  text-align:center;
  cursor:pointer;
  transition:background .2s,transform .2s;
}
.file-service:hover{
  background:#374151;
  transform:translateY(-2px);
}
.file-service i{
  font-size:1.5rem;
  margin-bottom:8px;
  display:block;
}
.file-service-name{
  font-size:.9rem;
  font-weight:500;
}
.file-service-desc{
  font-size:.75rem;
  color:var(--muted);
  margin-top:4px;
}
/* Swift-AI chat bubbles */
.swift-ai-response{
  border-left:4px solid var(--accent);
  padding-left:12px;
  margin:10px 0;
}
.swift-ai-header{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:8px;
}
.swift-ai-icon{
  width:24px;
  height:24px;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:.9rem;
}
.voice-status{
  position:fixed;
  top:20px;
  right:20px;
  background:#111827;
  padding:12px 16px;
  border-radius:12px;
  display:none;
  align-items:center;
  gap:10px;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
  z-index:1000;
}
.swift-ai-status{
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.voice-dot{
  width:10px;
  height:10px;
  background:#ef4444;
  border-radius:50%;
  animation:pulse 1.5s infinite;
}
.swift-ai-dot{
  background:#8b5cf6;
}
.voice-text{
  font-size:.9rem;
}
.loading-spinner{
  border:3px solid #1f2937;
  border-top:3px solid #2563eb;
  border-radius:50%;
  width:24px;
  height:24px;
  animation:spin 1s linear infinite;
  margin:10px auto;
}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.6;}}

/* Responsive tweaks */
@media(max-width:768px){
  .google-bar{flex-direction:column;align-items:stretch;}
  .search-bar{max-width:100%;}
  .tabs{overflow-x:auto;}
}
</style>
</head>

<body>
<!-- USER IMAGE TOP-LEFT -->
<img id="userImage" class="user-image" src="user-image.jpg" alt="User" title="User image">

<!-- GOOGLE-STYLE TOP BAR -->
<div class="google-bar">
  <div class="google-logo">üöÄ Swift Search</div>
  <div class="search-bar">
    <input id="q" class="search-input" placeholder="Search or ask Swift AI...">
    <div class="search-bar-icons">
      <button class="icon-btn text-search" title="Search">üîç</button>
      <button class="icon-btn swift-ai" title="Swift AI">‚ú®</button>
      <button class="icon-btn voice-search" title="Voice Search">üé§</button>
      <button class="icon-btn file-search" title="File Services">üìÅ</button>
    </div>
  </div>
</div>

<!-- GOOGLE-STYLE TABS -->
<div class="tabs">
  <div class="tab active" data-type="web">All</div>
  <div class="tab" data-type="images">Images</div>
  <div class="tab" data-type="videos">Videos</div>
  <div class="tab" data-type="news">News</div>
  <div class="tab" data-type="maps">Maps</div>
</div>

<!-- VOICE STATUS */
<div class="voice-status" id="voiceStatus">
  <div class="voice-dot"></div>
  <div class="voice-text">Listening... Speak now</div>
</div>
<div class="voice-status swift-ai-status" id="swiftAiStatus" style="display:none">
  <div class="voice-dot swift-ai-dot"></div>
  <div class="voice-text">Swift AI is listening...</div>
</div>

<!-- RESULTS AREA -->
<div id="results"></div>

<!-- FILE SERVICES MODAL (same as old file) -->
<div class="service-modal" id="fileModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">File Services</h3>
      <button class="modal-close" onclick="closeFileModal()">√ó</button>
    </div>
    <div class="file-upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <p>Drag & drop files here or click to browse</p>
      <input type="file" id="fileInput" multiple style="display:none">
      <p class="note">Supports images, documents, audio, and video files</p>
    </div>
    <div id="fileList"></div>
    <div class="file-services">
      <div class="file-service" onclick="searchOnService('googleDrive')">
        <i>üìÅ</i>
        <div class="file-service-name">Google Drive</div>
        <div class="file-service-desc">Cloud storage</div>
      </div>
      <div class="file-service" onclick="searchOnService('dropbox')">
        <i>üì¶</i>
        <div class="file-service-name">Dropbox</div>
        <div class="file-service-desc">File sharing</div>
      </div>
      <div class="file-service" onclick="searchOnService('onedrive')">
        <i>‚òÅÔ∏è</i>
        <div class="file-service-name">OneDrive</div>
        <div class="file-service-desc">Microsoft cloud</div>
      </div>
      <div class="file-service" onclick="searchOnService('icloud')">
        <i>üçé</i>
        <div class="file-service-name">iCloud</div>
        <div class="file-service-desc">Apple cloud</div>
      </div>
      <div class="file-service" onclick="openService('wetransfer')">
        <i>üì§</i>
        <div class="file-service-name">WeTransfer</div>
        <div class="file-service-desc">File transfer</div>
      </div>
      <div class="file-service" onclick="openService('figma')">
        <i>üé®</i>
        <div class="file-service-name">Figma</div>
        <div class="file-service-desc">Design files</div>
      </div>
      <div class="file-service" onclick="openService('github')">
        <i>üíª</i>
        <div class="file-service-name">GitHub</div>
        <div class="file-service-desc">Code files</div>
      </div>
      <div class="file-service" onclick="openService('notion')">
        <i>üìù</i>
        <div class="file-service-name">Notion</div>
        <div class="file-service-desc">Documents</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- CONFIG ---------- */
const SWIFT_AI_KEY = 'YOUR_GEMINI_2.5_FLASH_FREE_KEY_HERE'; // <‚îÄ‚îÄ drop key here
let swiftAiMode = false;
let currentTab = 'web'; // web | images | videos | news | maps
let currentPage = 1;
let lastQuery = '';

/* ---------- DOM ---------- */
const input = document.getElementById('q');
const results = document.getElementById('results');
const voiceBtn = document.querySelector('.voice-search');
const swiftAiBtn = document.querySelector('.swift-ai');
const fileBtn = document.querySelector('.file-search');
const voiceStatus = document.getElementById('voiceStatus');
const swiftAiStatus = document.getElementById('swiftAiStatus');
const fileModal = document.getElementById('fileModal');
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const fileList = document.getElementById('fileList');
const tabs = document.querySelectorAll('.tab');

/* ---------- GOOGLE-CLONE SEARCH (WEB / IMG / VID / NEWS / MAPS) ---------- */
async function googleCloneSearch(rawQuery, type = 'web', page = 1){
  lastQuery = rawQuery;
  currentTab = type;
  currentPage = page;
  results.innerHTML = '<div class="loading-spinner"></div>';
  // Use Bing-Azure cognitive demo endpoint (JSON) ‚Äì no key needed for demo
  const endpoint = 'https://api.cognitive.microsoft.com/bing/v7.0/search';
  const headers = { 'Ocp-Apim-Subscription-Key': '00000000000000000000000000000000' }; // demo key
  const params = new URLSearchParams({
    q: rawQuery,
    count: 10,
    offset: (page - 1) * 10,
    mkt: 'en-US',
    safeSearch: 'Moderate',
    responseFilter: type === 'web' ? 'Webpages' : type === 'images' ? 'Images' : type === 'videos' ? 'Videos' : type === 'news' ? 'News' : 'Places'
  });
  try {
    const res = await fetch(`${endpoint}?${params}`, { headers });
    const data = await res.json();
    renderGoogleClone(data, type);
  } catch (e) {
    // fallback to duck inline
    inlineWebSearch(rawQuery);
  }
}

function renderGoogleClone(data, type){
  let html = '';
  if (type === 'web' && data.webPages) {
    data.webPages.value.forEach(r => {
      html += `
        <div class="result-card">
          <a class="result-title" href="${r.url}" target="_blank" rel="noreferrer">
            <img class="result-favicon" src="https://www.google.com/s2/favicons?domain=${new URL(r.url).hostname}">
            ${r.name}
          </a>
          <div class="result-url">${r.displayUrl}</div>
          <div class="result-snippet">${r.snippet}</div>
        </div>`;
    });
  } else if (type === 'images' && data.images) {
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin:0 16px;">';
    data.images.value.forEach(r => {
      html += `<a href="${r.contentUrl}" target="_blank" rel="noreferrer"><img src="${r.thumbnailUrl}" style="width:100%;border-radius:8px;"></a>`;
    });
    html += '</div>';
  } else if (type === 'videos' && data.videos) {
    data.videos.value.forEach(r => {
      html += `
        <div class="result-card">
          <a class="result-title" href="${r.contentUrl}" target="_blank" rel="noreferrer">
            <img class="result-favicon" src="https://www.google.com/s2/favicons?domain=youtube.com">
            ${r.name}
          </a>
          <div class="result-snippet">${r.description}</div>
        </div>`;
    });
  } else if (type === 'news' && data.news) {
    data.news.value.forEach(r => {
      html += `
        <div class="result-card">
          <a class="result-title" href="${r.url}" target="_blank" rel="noreferrer">
            <img class="result-favicon" src="https://www.google.com/s2/favicons?domain=${new URL(r.url).hostname}">
            ${r.name}
          </a>
          <div class="result-snippet">${r.description}</div>
        </div>`;
    });
  } else if (type === 'maps' && data.places) {
    data.places.value.forEach(r => {
      html += `
        <div class="result-card">
          <a class="result-title" href="${r.url}" target="_blank" rel="noreferrer">
            <img class="result-favicon" src="https://www.google.com/s2/favicons?domain=maps.google.com">
            ${r.name}
          </a>
          <div class="result-snippet">${r.address}</div>
        </div>`;
    });
  } else {
    html = '<div class="result-card">No results found.</div>';
  }
  // pagination
  if (html) html += `
    <div class="pagination">
      <button class="page-btn" onclick="googleCloneSearch('${lastQuery}','${currentTab}',${currentPage-1})" ${currentPage===1?'disabled':''}>‚Äπ Prev</button>
      <span style="color:var(--muted);font-size:.9rem;">Page ${currentPage}</span>
      <button class="page-btn" onclick="googleCloneSearch('${lastQuery}','${currentTab}',${currentPage+1})">Next ‚Ä∫</button>
    </div>`;
  results.innerHTML = html;
}

/* ---------- TAB SWITCH ---------- */
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  if (lastQuery) googleCloneSearch(lastQuery, t.dataset.type, 1);
}));

/* ---------- SWIFT AI (same as before) ---------- */
async function swiftAIQuery(prompt){
  if (!SWIFT_AI_KEY || SWIFT_AI_KEY === 'YOUR_GEMINI_2.5_FLASH_FREE_KEY_HERE') return 'Swift AI offline (no key).';
  try {
    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${SWIFT_AI_KEY}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ contents: [{ parts: [{ text: `You are Swift AI, a helpful voice assistant. Reply conversationally to: "${prompt}". Keep it short.` }] }] })
    });
    const data = await res.json();
    return data?.candidates?.[0]?.content?.parts?.[0]?.text || 'I‚Äôm here‚Äîwhat else can I do?';
  } catch (e) {
    return 'Connection trouble.';
  }
}

function speakSwiftAIResponse(text){
  if ('speechSynthesis' in window) {
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 1; u.pitch = 1; u.volume = 1;
    speechSynthesis.speak(u);
  }
}

async function handleSwiftAIQuery(query){
  const q = query.toLowerCase().trim();
  if (q.includes('hey swift') || q.includes('hello swift') || q.includes('okay swift')) {
    const response = await swiftAIQuery(query.replace(/hey swift|hello swift|okay swift/gi, '').trim());
    speakSwiftAIResponse(response);
    return `
      <div class="result-card">
        <div class="swift-ai-header">
          <div class="swift-ai-icon">‚ú®</div>
          <b>Swift AI</b>
        </div>
        <div class="result-snippet">${response}</div>
        <div class="note" style="color:var(--muted);font-size:.8rem;">Speaking response‚Ä¶</div>
      </div>`;
  }
  if (q.includes('weather')) return inlineWebSearch('weather');
  if (q.includes('joke') || q.includes('funny')) {
    const jokes = [
      "Why don't scientists trust atoms? Because they make up everything!",
      "Why did the scarecrow win an award? Because he was outstanding in his field!",
      "What do you call a fake noodle? An impasta!"
    ];
    const joke = jokes[Math.floor(Math.random() * jokes.length)];
    speakSwiftAIResponse(joke);
    return `
      <div class="result-card">
        <div class="swift-ai-header">
          <div class="swift-ai-icon">‚ú®</div>
          <b>Swift AI</b>
        </div>
        <div class="result-snippet">${joke}</div>
      </div>`;
  }
  if (q.includes('calculate')) {
    try {
      const expr = q.replace(/calculate|what is|how much is/gi, '').trim();
      const ans = eval(expr.replace(/[^-()\d/*+.]/g, ''));
      speakSwiftAIResponse(`The result is ${ans}`);
      return `
        <div class="result-card">
          <div class="swift-ai-header">
            <div class="swift-ai-icon">‚ú®</div>
            <b>Swift AI</b>
          </div>
          <div class="result-snippet">üßÆ ${expr} = ${ans}</div>
        </div>`;
    } catch (e) {}
  }
  const response = await swiftAIQuery(query);
  speakSwiftAIResponse(response);
  return `
    <div class="result-card">
      <div class="swift-ai-header">
        <div class="swift-ai-icon">‚ú®</div>
        <b>Swift AI</b>
      </div>
      <div class="result-snippet">${response}</div>
    </div>`;
}

/* ---------- INLINE FALLBACK (Duck) ---------- */
async function inlineWebSearch(rawQuery){
  results.innerHTML = '<div class="loading-spinner"></div>';
  try {
    const res = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(rawQuery)}&format=json&no_html=1&skip_disambig=1`);
    const data = await res.json();
    let html = '';
    if (data.AbstractText) {
      html += `
        <div class="result-card">
          <a class="result-title" href="${data.AbstractURL}" target="_blank" rel="noreferrer">
            <img class="result-favicon" src="https://www.google.com/s2/favicons?domain=${new URL(data.AbstractURL).hostname}">
            ${data.Heading || rawQuery}
          </a>
          <div class="result-snippet">${data.AbstractText}</div>
        </div>`;
    }
    if (data.RelatedTopics && data.RelatedTopics.length) {
      data.RelatedTopics.slice(0, 8).forEach(r => {
        if (r.Text) {
          html += `
            <div class="result-card">
              <a class="result-title" href="${r.FirstURL}" target="_blank" rel="noreferrer">
                <img class="result-favicon" src="https://www.google.com/s2/favicons?domain=${new URL(r.FirstURL).hostname}">
                ${r.Text.split(' - ')[0]}
              </a>
              <div class="result-snippet">${r.Text.split(' - ').slice(1).join(' - ')}</div>
            </div>`;
        }
      });
    }
    if (!html) html = '<div class="result-card">No results found.</div>';
    results.innerHTML = html;
  } catch (e) {
    results.innerHTML = '<div class="result-card">Could not retrieve results.</div>';
  }
}

/* ---------- VOICE SEARCH ---------- */
let isListening = false;
let recognition = null;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US';
  recognition.onstart = () => {
    isListening = true;
    voiceBtn.classList.add('listening');
    voiceStatus.style.display = 'flex';
  };
  recognition.onresult = (e) => {
    const transcript = e.results[0][0].transcript;
    input.value = transcript;
    handle(transcript);
  };
  recognition.onerror = () => {
    voiceStatus.style.display = 'none';
  };
  recognition.onend = () => {
    isListening = false;
    voiceBtn.classList.remove('listening');
    voiceStatus.style.display = 'none';
  };
  voiceBtn.addEventListener('click', () => {
    if (isListening) recognition.stop(); else recognition.start();
  });
} else {
  voiceBtn.style.display = 'none';
}

/* ---------- FILE SERVICES (same as old file) ---------- */
function openFileModal(){
  fileModal.style.display = 'flex';
  renderFileList();
}
function closeFileModal(){
  fileModal.style.display = 'none';
}
function searchOnService(service){
  const query = input.value.trim();
  if (query) {
    switch(service){
      case 'googleDrive': inlineWebSearch('site:drive.google.com ' + query); break;
      case 'dropbox': inlineWebSearch('site:dropbox.com ' + query); break;
      case 'onedrive': inlineWebSearch('site:onedrive.live.com ' + query); break;
      case 'icloud': inlineWebSearch('site:icloud.com ' + query); break;
    }
  } else {
    openService(service);
  }
  closeFileModal();
}
function openService(service){
  const urls = {
    wetransfer: 'https://wetransfer.com',
    figma: 'https://figma.com',
    github: 'https://github.com',
    notion: 'https://notion.so',
    googledrive: 'https://drive.google.com',
    dropbox: 'https://dropbox.com',
    onedrive: 'https://onedrive.live.com',
    icloud: 'https://icloud.com'
  };
  window.open(urls[service] || `https://${service}.com`, '_blank');
  closeFileModal();
}
uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => {
  uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  uploadArea.classList.remove('dragover');
  handleFiles(Array.from(e.dataTransfer.files));
});
fileInput.addEventListener('change', (e) => {
  handleFiles(Array.from(e.target.files));
  fileInput.value = '';
});
function handleFiles(files){
  files.forEach(file => {
    uploadedFiles.unshift({
      name: file.name,
      size: file.size,
      type: file.type,
      lastModified: file.lastModified,
      preview: URL.createObjectURL(file)
    });
    if (uploadedFiles.length > 10) uploadedFiles.pop();
    localStorage.setItem("uploadedFiles", JSON.stringify(uploadedFiles));
  });
  renderFileList();
  results.innerHTML = `<div class="result-card"><b>üìÅ Files Uploaded</b><p>Successfully uploaded ${files.length} file(s).</p></div>`;
}
function renderFileList(){
  fileList.innerHTML = uploadedFiles.length > 0 ?
    uploadedFiles.slice(0, 5).map(file => `
      <div class="file-item">
        <div class="file-name">üìÑ ${file.name}</div>
        <div class="file-size">${formatFileSize(file.size)}</div>
        <div class="file-actions">
          <button class="file-action-btn" onclick="openFile('${file.name}')" title="Open">üîç</button>
          <button class="file-action-btn" onclick="removeFile('${file.name}')" title="Remove">üóëÔ∏è</button>
        </div>
      </div>`).join('') :
    '<p class="note" style="text-align:center">No files uploaded yet</p>';
}
function openFile(filename){
  const file = uploadedFiles.find(f => f.name === filename);
  if (file && file.preview) window.open(file.preview, '_blank');
}
function removeFile(filename){
  uploadedFiles = uploadedFiles.filter(f => f.name !== filename);
  localStorage.setItem("uploadedFiles", JSON.stringify(uploadedFiles));
  renderFileList();
}
function formatFileSize(bytes){
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

/* ---------- MUSIC (same as old file) ---------- */
function parseMusicQuery(query){
  const patterns = [
    /play\s+"(.+?)"\s+by\s+(.+)/i,
    /play\s+(.+?)\s+by\s+(.+)/i,
    /play\s+(.+)\s+on\s+(.+)/i,
    /play\s+(.+)/i
  ];
  for (const pattern of patterns) {
    const match = query.match(pattern);
    if (match) {
      return {
        song: match[1].trim(),
        artist: match[2] ? match[2].trim() : '',
        fullQuery: `${match[1].trim()} ${match[2] ? match[2].trim() : ''}`.trim()
      };
    }
  }
  return { song: query.replace(/^play\s+/i, '').trim(), artist: '', fullQuery: query.replace(/^play\s+/i, '').trim() };
}
async function autoPlayYouTube(query) {
  const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&q=${encodeURIComponent(query)}&key=AIzaSyCKFVBOrnw-SlRVyT8bb3zfwex4dvHSf3w&maxResults=1`);
  const data = await res.json();
  if (!data.items || !data.items.length) return alert("No video found");
  embedPlayer(`https://www.youtube.com/embed/${data.items[0].id.videoId}?autoplay=1`);
}
function autoPlayYouTubeMusic(query) {
  window.open(`https://music.youtube.com/search?q=${encodeURIComponent(query)}`, "_blank");
}
function autoPlaySpotify(query) {
  window.open(`https://open.spotify.com/search/${encodeURIComponent(query)}`, "_blank");
}
function autoPlaySoundCloud(query) {
  window.open(`https://soundcloud.com/search?q=${encodeURIComponent(query)}`, "_blank");
}
function embedPlayer(src, msg) {
  const box = document.getElementById('embedBox');
  if (!box) return;
  if (msg) {
    box.innerHTML = `<p class="note">${msg}</p>`;
    return;
  }
  box.innerHTML = `<iframe src="${src}" width="100%" height="300" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
}

/* ---------- MAIN HANDLER ---------- */
async function handle(query){
  const q = query.trim();
  if (!q) return;
  addToHistory(q);
  // Swift-AI wake words
  if (swiftAiMode || q.toLowerCase().includes('hey swift') || q.toLowerCase().includes('okay swift')) {
    results.innerHTML = '<div class="loading-spinner"></div>';
    const html = await handleSwiftAIQuery(q);
    results.innerHTML = html;
    return;
  }
  // Music intents
  if (q.toLowerCase().startsWith('play ')) {
    const musicData = parseMusicQuery(q);
    results.innerHTML = `
      <div class="result-card">
        <b>üéµ Play: ${musicData.fullQuery}</b>
        ${musicData.artist ? `<p class="note">Artist: ${musicData.artist}</p>` : ''}
        <div class="music-options">
          <button class="music-btn" onclick="autoPlayYouTube('${musicData.fullQuery.replace(/'/g, "\\'")}')">YouTube</button>
          <button class="music-btn" onclick="autoPlayYouTubeMusic('${musicData.fullQuery.replace(/'/g, "\\'")}')">YouTube Music</button>
          <button class="music-btn" onclick="autoPlaySpotify('${musicData.fullQuery.replace(/'/g, "\\'")}')">Spotify</button>
          <button class="music-btn" onclick="autoPlaySoundCloud('${musicData.fullQuery.replace(/'/g, "\\'")}')">SoundCloud</button>
        </div>
        <p class="note" style="margin-top:10px;">Auto-playing on YouTube‚Ä¶</p>
        <div id="embedBox" style="margin-top:10px;"></div>
      </div>`;
    setTimeout(() => autoPlayYouTube(musicData.fullQuery), 600);
    return;
  }
  // File intents
  const lower = q.toLowerCase();
  if (lower.startsWith('find ') || lower.startsWith('search ') || lower.includes('file') || lower.includes('document')) {
    if (lower.includes('drive') || lower.includes('google')) {
      googleCloneSearch('site:drive.google.com ' + q, 'web', 1);
      return;
    }
    if (lower.includes('dropbox')) {
      googleCloneSearch('site:dropbox.com ' + q, 'web', 1);
      return;
    }
    openFileModal();
    return;
  }
  // Explicit ‚Äúopen‚Äù commands ‚Äì only these open new tab
  if (lower.startsWith('open ')) {
    const site = q.replace('open ', '').replace(/\s+/g, '');
    window.open(`https://${site}.com`, '_blank');
    results.innerHTML = `<div class="result-card">Opening ${site}.com</div>`;
    return;
  }
  if (lower.includes('gmail') || lower.includes('email')) {
    window.open('https://mail.google.com', '_blank');
    results.innerHTML = `<div class="result-card">Opening Gmail</div>`;
    return;
  }
  if (lower.includes('youtube') && !lower.includes('youtube music')) {
    window.open(`https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`, '_blank');
    results.innerHTML = `<div class="result-card">Opening YouTube for: ${q}</div>`;
    return;
  }
  if (lower.includes('spotify')) {
    window.open(`https://open.spotify.com/search/${encodeURIComponent(q)}`, '_blank');
    results.innerHTML = `<div class="result-card">Opening Spotify for: ${q}</div>`;
    return;
  }
  // Default: google clone search on active tab
  googleCloneSearch(q, currentTab, 1);
}

/* ---------- HISTORY ---------- */
let searchHistory = JSON.parse(localStorage.getItem("searchHistory")) || [];
let uploadedFiles = JSON.parse(localStorage.getItem("uploadedFiles")) || [];
function addToHistory(q){
  if (!q.trim()) return;
  searchHistory = searchHistory.filter(item => item.toLowerCase() !== q.toLowerCase());
  searchHistory.unshift(q);
  searchHistory = searchHistory.slice(0, 10);
  localStorage.setItem("searchHistory", JSON.stringify(searchHistory));
}
function showHistory(){
  if (searchHistory.length === 0 && uploadedFiles.length === 0) return '';
  let html = '';
  if (uploadedFiles.length > 0) {
    html += `
      <div class="result-card">
        <b>Recent Files</b>
        ${uploadedFiles.slice(0, 3).map(f => `
          <div class="file-item" onclick="openFile('${f.name}')">
            <span class="file-name">üìÑ ${f.name}</span>
            <span class="file-size">${formatFileSize(f.size)}</span>
          </div>`).join('')}
      </div>`;
  }
  if (searchHistory.length > 0) {
    html += `
      <div class="result-card">
        <b>Recent Searches</b>
        ${searchHistory.map(item => `
          <div class="history-item" onclick="input.value='${item.replace(/'/g, "\\'")}'; handle('${item.replace(/'/g, "\\'")}')">
            ${item}
          </div>`).join('')}
      </div>`;
  }
  return html;
}

/* ---------- KEYBOARD SHORTCUTS ---------- */
input.addEventListener('keydown', e => {
  if (e.key === 'Enter') handle(input.value);
  if (e.key === '/') {
    e.preventDefault();
    input.focus();
    input.select();
  }
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'l') {
    e.preventDefault();
    input.focus();
    input.select();
  }
  if (e.key === 'Escape') {
    if (isListening && recognition) recognition.stop();
    input.value = '';
    input.blur();
  }
  if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
    e.preventDefault();
    openFileModal();
  }
  if ((e.ctrlKey || e.metaKey) && e.key === ' ') {
    e.preventDefault();
    // toggle Swift-AI mode
    swiftAiMode = !swiftAiMode;
    swiftAiBtn.classList.toggle('active', swiftAiMode);
    input.placeholder = swiftAiMode ? 'Ask Swift AI anything‚Ä¶' : 'Search or ask Swift AI‚Ä¶';
  }
});

/* ---------- INITIALIZE ---------- */
results.innerHTML = showHistory();
input.focus();
if (searchHistory.length === 0 && uploadedFiles.length === 0) {
  setTimeout(() => {
    results.innerHTML = `
      <div class="result-card">
        <div class="swift-ai-header">
          <div class="swift-ai-icon">‚ú®</div>
          <b>Welcome to Swift Search ‚Äì Google Clone Edition</b>
        </div>
        <p>Try searching the web, images, videos, news, or maps. Say ‚ÄúHey Swift‚Äù for AI, ‚Äúplay ‚Ä¶‚Äù for music, or ‚Äúopen gmail‚Äù to launch sites.</p>
      </div>`;
  }, 500);
}
</script>
</body>
</html>
